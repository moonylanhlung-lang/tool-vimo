<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Email Resend Dashboard</title>

<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    margin: 0;
    padding: 20px;
    min-height: 100vh;
}

.container {
    max-width: 900px;
    margin: auto;
    background: rgba(255,255,255,.95);
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 15px 35px rgba(0,0,0,.1);
}

.header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom:2px solid #eee;
    padding-bottom:15px;
    margin-bottom:25px;
}

.search-input {
    width:100%;
    padding:15px;
    border-radius:10px;
    border:2px solid #ddd;
    font-size:15px;
}

.search-btn {
    margin-top:10px;
    padding:14px 25px;
    border:none;
    border-radius:10px;
    font-weight:600;
    cursor:pointer;
    color:#fff;
    background:linear-gradient(135deg,#f093fb,#f5576c);
}

.search-btn[disabled] {
    opacity:.6;
    cursor:not-allowed;
}

.resend-btn {
    padding:8px 14px;
    border:none;
    border-radius:6px;
    background:linear-gradient(135deg,#4ecdc4,#44a08d);
    color:#fff;
    cursor:pointer;
}

ul {
    list-style:none;
    padding:0;
}

li {
    background:#f7f7f7;
    padding:15px;
    border-radius:10px;
    margin-bottom:10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

/* Toast */
#toast {
    display:none;
    position:fixed;
    top:20px;
    right:20px;
    background:#2ecc71;
    color:white;
    padding:15px 20px;
    border-radius:8px;
    box-shadow:0 10px 25px rgba(0,0,0,.2);
    z-index:9999;
}
</style>
</head>

<body>

<div id="toast"></div>

<div class="container">

    <div class="header">
        <h3>ğŸ“§ Email Resend Dashboard</h3>
        <a href="/logout">ÄÄƒng xuáº¥t</a>
    </div>

    <textarea id="email" class="search-input" rows="4"
placeholder="merchant1@gmail.com
merchant2@gmail.com"></textarea>

    <button class="search-btn" onclick="search()">ğŸ” TÃ¬m email</button>

    <button id="autoBtn" class="search-btn"
        style="background:linear-gradient(135deg,#ff9a00,#ff6a00)"
        onclick="autoResend()">
        ğŸ”¥ Auto resend email má»›i nháº¥t
    </button>

    <h4 style="margin-top:30px;">ğŸ“¨ Email tÃ¬m Ä‘Æ°á»£c</h4>
    <ul id="list"></ul>

    <h4 style="margin-top:30px;">ğŸ“œ Lá»‹ch sá»­ resend</h4>
    <ul id="log-list"></ul>

</div>

<script>
function showToast(msg, time = 10000, color = "#2ecc71") {
    const toast = document.getElementById("toast");
    toast.style.background = color;
    toast.innerText = msg;
    toast.style.display = "block";
    setTimeout(() => toast.style.display = "none", time);
}

async function search() {
    const emails = email.value.split("\n").map(e=>e.trim()).filter(e=>e);
    list.innerHTML = "";

    for (const m of emails) {
        const f = new FormData();
        f.append("merchant_email", m);

        const r = await fetch("/search", { method:"POST", body:f });
        const d = await r.json();

        d.forEach(mail => {
            const li = document.createElement("li");
            li.innerHTML = `
                <span>${mail.subject}</span>
                <button class="resend-btn"
                    onclick="manualResend('${mail.id}','${m}')">
                    Gá»­i láº¡i
                </button>`;
            list.appendChild(li);
        });
    }
}

async function manualResend(id, merchant) {
    const f = new FormData();
    f.append("email_id", id);
    f.append("merchant_email", merchant);

    await fetch("/resend", { method:"POST", body:f });
    showToast("âœ… ÄÃ£ resend email");
    loadLogs();
}

async function autoResend() {
    const btn = document.getElementById("autoBtn");
    btn.disabled = true;
    btn.innerText = "â³ Äang gá»­i...";

    const emails = email.value.split("\n").map(e=>e.trim()).filter(e=>e);

    for (const m of emails) {
        const f = new FormData();
        f.append("merchant_email", m);

        const r = await fetch("/auto-resend", { method:"POST", body:f });
        const d = await r.json();

        if (d.status === "success") {
            showToast(`âœ… ${m}\n${d.resent_subject}`, 4000);
        } else {
            showToast(`âŒ ${m}: ${d.message}`, 5000, "#e74c3c");
        }
    }

    btn.disabled = false;
    btn.innerText = "ğŸ”¥ Auto resend email má»›i nháº¥t";
    loadLogs();
}

async function loadLogs() {
    const r = await fetch("/logs");
    const d = await r.json();
    const ul = document.getElementById("log-list");
    ul.innerHTML = "";

    d.slice(-10).reverse().forEach(l => {
        const li = document.createElement("li");
        li.innerHTML = `
            <small>
            â± ${new Date(l.time).toLocaleString()}<br>
            ğŸ‘¤ ${l.user}<br>
            ğŸ“§ ${l.merchant_email}<br>
            ğŸ“¨ ${l.subject}
            </small>`;
        ul.appendChild(li);
    });
}

loadLogs();
</script>

</body>
</html>